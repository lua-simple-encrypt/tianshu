name: tianshu

services:
  # ============================================================================
  # Redis (高性能任务队列)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: tianshu-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - tianshu-network

  # ============================================================================
  # RustFS Object Storage (S3 Compatible)
  # ============================================================================
  rustfs:
    image: rustfs/rustfs:latest
    container_name: tianshu-rustfs
    restart: unless-stopped
    ports:
      - "${RUSTFS_PORT:-9000}:9000"
      - "${RUSTFS_CONSOLE_PORT:-9001}:9001"
    volumes:
      - rustfs-data:/data
      - rustfs-logs:/logs
    environment:
      - TZ=Asia/Shanghai
      - RUSTFS_ROOT_USER=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - RUSTFS_ROOT_PASSWORD=${RUSTFS_SECRET_KEY:-rustfsadmin}
    networks:
      - tianshu-network

  # ============================================================================
  # Backend API Server
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    image: tianshu-backend:latest
    container_name: tianshu-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - "D:/aiworkspace/models/mineru:/root/.cache/mineru/models:ro"
      - ./backend/mineru.json:/root/mineru.json:ro
      - ./data:/app/data:rw
    environment:
      - TZ=Asia/Shanghai
      - MINERU_MODEL_SOURCE=local
      - DATABASE_PATH=/app/data/db/mineru_tianshu.db
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    networks:
      - tianshu-network
    depends_on:
      - rustfs

  # ============================================================================
  # LitServe GPU Worker (核心推理引擎)
  # ============================================================================
  worker:
    image: tianshu-backend:latest
    container_name: tianshu-worker
    restart: unless-stopped
    shm_size: 32g
    command: ["python", "litserve_worker.py"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - "D:/aiworkspace/models/mineru:/root/.cache/mineru/models:ro"
      - ./data:/app/data:rw
    environment:
      - TZ=Asia/Shanghai
      - PADDLE_VLM_URL=http://host.docker.internal:8118/v1
      - MINERU_VLM_URL=http://host.docker.internal:8119/v1
      - PDF_SPLIT_THRESHOLD_PAGES=50
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    networks:
      - tianshu-network
    depends_on:
      - backend

  # ============================================================================
  # Frontend (Vue 3 UI)
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    image: tianshu-frontend:latest
    container_name: tianshu-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - VITE_API_BASE_URL=http://localhost:8000
    networks:
      - tianshu-network
    depends_on:
      - backend

networks:
  tianshu-network:
    driver: bridge

# 注意：下面的每一项都必须顶格写，不能有额外的空格
volumes:
  redis-data:
  rustfs-data:
  rustfs-logs:
