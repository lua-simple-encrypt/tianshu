# Tianshu (天枢) - 企业级 AI 数据预处理平台完整编排
# 适配: MinerU 2.7.6 + PaddleX 3.4.1 + 外部 vLLM (8118/8119 端口)
# 更新: 强化 VLM 共享内存、双远程引擎链路、本地模型 D 盘挂载

name: tianshu

services:
  # ============================================================================
  # Redis (高性能任务队列)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: tianshu-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    environment:
      - TZ=Asia/Shanghai
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - tianshu-network

  # ============================================================================
  # RustFS Object Storage (S3 Compatible)
  # ============================================================================
  rustfs:
    image: rustfs/rustfs:latest
    container_name: tianshu-rustfs
    restart: unless-stopped
    ports:
      - "${RUSTFS_PORT:-9000}:9000"
      - "${RUSTFS_CONSOLE_PORT:-9001}:9001"
    volumes:
      - rustfs-data:/data
      - rustfs-logs:/logs
    environment:
      - TZ=Asia/Shanghai
      - RUSTFS_ROOT_USER=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - RUSTFS_ROOT_PASSWORD=${RUSTFS_SECRET_KEY:-rustfsadmin}
    networks:
      - tianshu-network

  # ============================================================================
  # Backend API Server (负责构建镜像与任务分发)
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      # [关键优化] 使用宿主机网络构建，防止 apt/pip 访问镜像源超时
      network: host
      cache_from:
        - tianshu-backend:latest
    image: tianshu-backend:latest
    container_name: tianshu-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      # [模型挂载] 从 D 盘映射本地权重
      - "D:/aiworkspace/models/mineru/MinerU2.5-2509-1.2B:/root/.cache/mineru/models/MinerU2.5-2509-1.2B:ro"
      - "D:/aiworkspace/models/mineru/PDF-Extract-Kit-1.0:/root/.cache/mineru/models/PDF-Extract-Kit-1.0:ro"
      # [配置挂载] MinerU 核心配置文件
      - ./backend/mineru.json:/root/mineru.json:ro
      # 数据与持久化
      - ./data/uploads:/app/data/uploads:rw
      - ./data/output:/app/data/output:rw
      - ./data/db:/app/data/db:rw
      - ./logs/backend:/app/logs:rw
    environment:
      - TZ=Asia/Shanghai
      - HOST=0.0.0.0
      - API_PORT=8000
      - WORKER_URL=http://worker:8001
      - MINERU_CONFIG_FILE=/root/mineru.json
      - MINERU_MODEL_SOURCE=local
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-tianshu_secret_666}
      - DATABASE_PATH=/app/data/db/mineru_tianshu.db
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    networks:
      - tianshu-network
    depends_on:
      - rustfs

  # ============================================================================
  # LitServe GPU Worker (核心推理引擎)
  # ============================================================================
  worker:
    image: tianshu-backend:latest
    container_name: tianshu-worker
    restart: unless-stopped
    command: ["worker", "python", "litserve_worker.py"]
    ports:
      - "${WORKER_PORT:-8001}:8001"
    # [性能优化] 关键：为了 VLM 推理，增加共享内存到 32G
    shm_size: 32g
    volumes:
      - "D:/aiworkspace/models/mineru/MinerU2.5-2509-1.2B:/root/.cache/mineru/models/MinerU2.5-2509-1.2B:ro"
      - "D:/aiworkspace/models/mineru/PDF-Extract-Kit-1.0:/root/.cache/mineru/models/PDF-Extract-Kit-1.0:ro"
      - ./backend/mineru.json:/root/mineru.json:ro
      - ./data/uploads:/app/data/uploads:rw
      - ./data/output:/app/data/output:rw
      - ./logs/worker:/app/logs:rw
    environment:
      - TZ=Asia/Shanghai
      - HOST=0.0.0.0
      - WORKER_PORT=8001
      - MINERU_CONFIG_FILE=/root/mineru.json
      - MINERU_MODEL_SOURCE=local
      # [远程 VLM 路由] 
      # 8118 -> PaddleOCR-VL-1.5 | 8119 -> MinerU-VLM-1.2B
      - PADDLE_VLM_URL=http://host.docker.internal:8118/v1
      - MINERU_VLM_URL=http://host.docker.internal:8119/v1
      - VLLM_API_URL=http://host.docker.internal:8118/v1
      # PDF 拆分策略
      - PDF_SPLIT_THRESHOLD_PAGES=50
    # [网络穿透] 允许容器访问宿主机开启的 vLLM 端口
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          memory: ${WORKER_MEMORY_LIMIT:-24G}
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    networks:
      - tianshu-network
    depends_on:
      - backend

  # ============================================================================
  # MCP Server
  # ============================================================================
  mcp-server:
    image: tianshu-backend:latest
    container_name: tianshu-mcp
    restart: unless-stopped
    command: ["mcp", "python", "mcp_server.py"]
    ports:
      - "${MCP_PORT:-8002}:8002"
    volumes:
      - ./logs/mcp:/app/logs:rw
    environment:
      - TZ=Asia/Shanghai
      - API_URL=http://backend:8000
    networks:
      - tianshu-network
    depends_on:
      - backend

  # ============================================================================
  # Frontend (Vue 3 UI)
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      network: host
    image: tianshu-frontend:latest
    container_name: tianshu-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - TZ=Asia/Shanghai
      - VITE_API_BASE_URL=http://localhost:8000
    networks:
      - tianshu-network
    depends_on:
      - backend

networks:
  tianshu-network:
    driver: bridge
    name: tianshu-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  redis-data:
  rustfs-data:
